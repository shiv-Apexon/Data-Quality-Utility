<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Select Database, Table, and Columns</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Select2 CSS for searchable dropdowns -->
    <link href="https://cdn.jsdelivr.net/npm/select2@4.0.13/dist/css/select2.min.css" rel="stylesheet" />

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.0.13/dist/js/select2.min.js"></script>

    <style>
        /* Scrollable Div for tables and columns */
        #tables_list, #columns_list {
            max-height: 300px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <div class="d-flex justify-content-between w-100 mh-100">
            <h2>Select Database, Table, and Columns</h2>
            <button id="close_connection_btn" type="button" class="btn btn-primary" style="height: 40px; flex-shrink: 0;">Close Connection</button>
          </div>

        <!-- Database Dropdown (Searchable) -->
        <div class="mb-3">
            <label for="db_select" class="form-label">Select Database</label>
            <select class="form-select" id="db_select" style="width: 100%" required>
                <option value="" selected disabled>Select a Database</option>
                {% for db, tables in db_tables.items %}
                    <option value="{{ db }}">{{ db }}</option>
                {% endfor %}
            </select>
        </div>

        <!-- Tables Dropdown (Searchable, Initially Hidden) -->
        <div class="mb-3" id="tables_section" style="display:none;">
            <label for="table_select" class="form-label">Select Table</label>
            <select class="form-select" id="table_select" style="width: 100%" required>
                <option value="" selected disabled>Select a Table</option>
            </select>
        </div>

        <!-- Columns Section (Initially Hidden) -->
        <div id="columns_section" style="display:none;">
            <h5>Columns in the Selected Table:</h5>
            <div id="columns_list"></div>
        </div>

        <!-- Submit Button (Initially Disabled) -->
        <div class="mt-3">
            <button type="submit" class="btn btn-primary" id="submit_btn" disabled>Submit</button>
        </div>
    </div>

    <script>
        // Initialize Select2 for the dropdowns
        $(document).ready(function() {
            $('#db_select').select2();
            $('#table_select').select2();
        });

        // When a database is selected
        $('#db_select').change(function() {
            var dbName = $(this).val();

            if (dbName) {
                // Show the tables section and reset the tables dropdown
                $('#tables_section').show();
                $('#columns_section').hide();
                $('#columns_list').html('');
                $('#table_select').html('<option value="" selected disabled>Select a Table</option>'); // Reset table options
                
                // Fetch tables for the selected database via AJAX
                $.ajax({
                    url: "{% url 'get_tables' %}",
                    type: "GET",
                    data: { 'db_name': dbName,
                     },
                    success: function(data) {
                        // Append tables to the tables dropdown
                        var tables = data.tables;
                        if (tables.length > 0) {
                            tables.forEach(function(table) {
                                $('#table_select').append('<option value="' + table + '">' + table + '</option>');
                            });
                        }
                    }
                });
            } else {
                // Hide the tables section if no database is selected
                $('#tables_section').hide();
                $('#columns_section').hide();
            }
        });

        // When a table is selected
        $('#table_select').change(function() {
            var tableName = $(this).val();
            var dbName = $('#db_select').val();

            if (tableName) {
                // Show columns section and reset columns list
                $('#columns_section').show();
                $('#columns_list').html('');

                // Fetch columns for the selected table via AJAX
                $.ajax({
                    url: "{% url 'get_columns' %}",
                    type: "GET",
                    data: {
                        'db_name': dbName,
                        'table_name': tableName
                    },
                    success: function(data) {
                        // Append columns as checkboxes
                        var columns = data.columns;
                        if (columns.length > 0) {
                            columns.forEach(function(column) {
                                $('#columns_list').append(
                                    '<div class="form-check">' +
                                    '<input class="form-check-input" type="checkbox" name="columns" value="' + column + '" id="column_' + column + '" />' +
                                    '<label class="form-check-label" for="column_' + column + '">' + column + '</label>' +
                                    '</div>'
                                );
                            });
                        }
                    }
                });
            } else {
                // Hide the columns section if no table is selected
                $('#columns_section').hide();
            }
        });

        // Enable submit button when at least one column is selected
        $(document).on('change', "input[name='columns']", function() {
            var selectedColumns = $("input[name='columns']:checked").length;
            if (selectedColumns > 0) {
                $('#submit_btn').prop('disabled', false);  // Enable submit button
            } else {
                $('#submit_btn').prop('disabled', true);   // Disable submit button
            }
        });
        $('#close_connection_btn').click(function() {
        $.ajax({
            type: 'POST',
            url: '{% url "close_connection" %}',  // Django URL to close the connection
            data: { 'action': 'close' },
            success: function(response) {
                alert(response.message);  // Alert the user about the connection status
                
                // Redirect to the new URL received from the server
                window.location.href = response.redirect_url;
            },
            error: function() {
                alert('Error closing the connection.');
            }
        });
    });


    </script>

</body>
</html>
