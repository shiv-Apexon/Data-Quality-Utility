<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Select Database, Table, and Columns</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Select2 CSS for searchable dropdowns -->
    <link href="https://cdn.jsdelivr.net/npm/select2@4.0.13/dist/css/select2.min.css" rel="stylesheet" />

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.0.13/dist/js/select2.min.js"></script>

    <style>
        /* Scrollable Div for tables and columns */
        #tables_list, #columns_list {
            max-height: 300px;
            overflow-y: auto;
        }
        dialog{
            position: fixed;
            top: 90%;
            left: 50%;
            transform: translate(-50%,-50%);
            display: none;
            width: clamp(220px, 70vw, 611px);
            border-radius: 9px;
            height: clamp(200px, 89vh, 90vh);
            resize: both;
            overflow: auto;
        }
        dialog::backdrop{
            background-color: rgba(0, 0, 0, 0.63); 
            z-index: 1000;
        }        
    </style>
</head>
<body>
    <div class="container mt-4">
        <div class="d-flex justify-content-between w-100 mh-100">
            <h2>Select Database, Table, and Columns</h2>
            <button id="close_connection_btn" type="button" class="btn btn-primary" style="height: 40px; flex-shrink: 0;">Close Connection</button>
          </div>

        <!-- Database Dropdown (Searchable) -->
        <div class="mb-3">
            <label for="db_select" class="form-label">Select Database</label>
            <select class="form-select" id="db_select" style="width: 100%" required>
                <option value="" selected disabled>Select a Database</option>
                {% for db, tables in db_tables.items %}
                    <option value="{{ db }}">{{ db }}</option>
                {% endfor %}
            </select>
        </div>

        <!-- Tables Dropdown (Searchable, Initially Hidden) -->
        <div class="mb-3" id="tables_section" style="display:none;">
            <label for="table_select" class="form-label">Select Table</label>
            <select class="form-select" id="table_select" style="width: 100%" required multiple = 'multiple'>
                <option value="" selected disabled>Select a Table</option>
            </select>
        </div>

        <!-- Columns Section (Initially Hidden) -->
        <div id="columns_section" style="display:none;">
            <h3>Columns in the Selected Table:</h3>
            <div id="columns_list"></div>
        </div>

        <!-- Submit Button (Initially Disabled) -->
        <div class="mt-3">
            <button type="submit" class="btn btn-primary" id="submit_btn"  onclick="document.getElementById('report_area').style.display = 'block'; document.getElementById('report_area').showModal();">Generate Report</button>
            <button type="submit" class="btn btn-primary" id="save_columns" >Save </button>

        </div>
    </div>
    <dialog id="report_area">
        <button class="btn btn-primary mb-1 position-absolute bottom-0 mb-3" id="closeModalBtn" onclick="document.getElementById('report_area').close(); document.getElementById('report_area').style.display = 'none';">Close</button>    
    </dialog>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
    const modal = document.getElementById('report_area');
    const closeModalBtn = document.getElementById('closeModalBtn');

    closeModalBtn.addEventListener('click', () => {
      modal.close();  // Close the modal
    });
                // Initialize Select2 for the dropdowns
        $(document).ready(function() {
            // Initialize Select2 on the select elements
            $('#db_select').select2();
            $('#table_select').select2(); // This will now handle multi-select automatically after we add 'multiple' attribute
        });

        // When a database is selected
        $('#db_select').change(function() {
            var dbName = $(this).val();

            if (dbName) {
                // Show the tables section and reset the tables dropdown
                $('#tables_section').show();
                $('#columns_section').hide();
                $('#columns_list').html('');
                
                // Reset the table options (allow multiple selections)
                $('#table_select').html('<option value="" disabled>Select a Table</option>'); // Reset table options
                
                // Fetch tables for the selected database via AJAX
                $.ajax({
                    url: "{% url 'get_tables' %}",
                    type: "GET",
                    data: { 'db_name': dbName },
                    success: function(data) {
                        // Append tables to the tables dropdown
                        var tables = data.tables;
                        if (tables.length > 0) {
                            // Loop through the tables and append each one as an option
                            tables.forEach(function(table) {
                                $('#table_select').append('<option value="' + table + '">' + table + '</option>');
                            });
                            
                            // Initialize or re-initialize Select2 for the multi-select
                            $('#table_select').select2(); // Ensure it works after dynamically adding options
                        }
                        else {
                            // Show a message when there are no tables
                            $('#table_select').html('<p>No tables available</p>');
                        }
                    }
                });
            } else {
                // Hide the tables section if no database is selected
                $('#tables_section').hide();
                $('#columns_section').hide();
            }
        });




        $('#table_select').change(function() {
        var dbName = $('#db_select').val();  // Get selected database
        var selectedTables = $('#table_select').val();  // Get selected tables (array of table names)

        if (selectedTables.length > 0) {
            $('#columns_section').show();
            $('#columns_list').html('');
            $.ajax({
                url: "{% url 'get_columns' %}",  // URL to your Django view
                type: "GET",
                data: {
                    'db_name': dbName,
                    'table_name': selectedTables  // Send selected table names as an array
                },
                success: function(data) {
                    var tableAndColumns = data.table_and_columns;  // Get the table and columns data
                    console.log(tableAndColumns)
                    // Loop through each table and display its columns (handle this as needed)
                    for (var tableName in tableAndColumns) {
                        var columns = tableAndColumns[tableName];
                        
                        // Assuming you want to dynamically display these in HTML
                        var tableSection = $('<div class="table-section" id="table_' + tableName + '">');
                        tableSection.append('<hr><h4>' + tableName + '</h4><hr>');  // Add table name

                        columns.forEach(function(column) {
                        var columnDiv = $('<div class="form-group">');
                        columnDiv.append('<label style = "font-weight: 600">' + column + ':</label>');

                        // Create the dropdown button for column types
                        var dropdownHTML = `
                            <div class="mb-3">
                                <label for="column_select" class="form-label">Select Column Types</label>
                                <div id="column_select">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" value="1" id="null_type">
                                        <label class="form-check-label" for="null_type">
                                            NULL
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" value="2" id="string_type">
                                        <label class="form-check-label" for="string_type">
                                            STRING
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" value="3" id="number_type">
                                        <label class="form-check-label" for="number_type">
                                            NUMBER
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" value="4" id="date_type">
                                        <label class="form-check-label" for="date_type">
                                            DATE
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" value="5" id="boolean_type">
                                        <label class="form-check-label" for="boolean_type">
                                            BOOLEAN
                                        </label>
                                    </div>
                                    {% comment %} <div class="form-check">
                                        <input class="form-check-input" type="checkbox" value="6" id="timestamp_type">
                                        <label class="form-check-label" for="timestamp_type">
                                            TIMESTAMP
                                        </label>
                                    </div> {% endcomment %}
                                </div>
                            </div>

                        `;
                        
                        // Append the dropdown to the column div
                        columnDiv.append(dropdownHTML);

                        // Append the column div to the table section
                        tableSection.append(columnDiv);
                    });

                        $('#columns_list').append(tableSection);  // Append the table section to the DOM
                    }
                },
                error: function(error) {
                    console.log("Error fetching columns:", error);
                }
            });
        }
    });





    function saveColumnDetails() {
    // Prepare the data object to hold database name, tables, columns, and selected types
    var reportData = {};

    // Get the database name (you may need to update this to get it dynamically, if necessary)
    var dbName = $('#db_select').val(); // Assuming you have a field for the database name

    // Add database name to the report data
    reportData.db_name = dbName;

    // Iterate over the table sections
    $('.table-section').each(function() {
        var tableName = $(this).find('h4').text(); // Get the table name
        var columns = {};

        // Iterate over each column in the table section
        $(this).find('.form-group').each(function() {
            var columnName = $(this).find('label').first().text().replace(':', ''); // Get column name
            var selectedTypes = [];

            // Check which checkboxes are selected for this column
            $(this).find('.form-check-input:checked').each(function() {
                var typeValue = $(this).val();
                selectedTypes.push(typeValue); // Add selected type to array
            });

            // If no checkboxes are selected, we don't need to include the column
            if (selectedTypes.length > 0) {
                // Add the column's selected types to the columns object
                columns[columnName] = selectedTypes;
            }
        });

        // If the table has any selected columns, add it to the reportData object
        if (Object.keys(columns).length > 0) {
            reportData[tableName] = columns;
        }
    });

    // Send the gathered data via an AJAX request
    $.ajax({
        url: '/save_column_details/',  // Your Django view URL for saving the column details
        type: 'POST',
        data: {
            report_data: JSON.stringify(reportData),  // Send the reportData object as a JSON string
            csrfmiddlewaretoken: $('input[name="csrfmiddlewaretoken"]').val()  // CSRF token for security
        },
        success: function(response) {
            // Handle the server response here (e.g., display a success message)
            console.log('Column details saved successfully:', response);
            alert('Column details saved successfully!');
        },
        error: function(xhr, status, error) {
            // Handle the error response here (e.g., display an error message)
            console.log('Error saving column details:', error);
            alert('Error saving column details: ' + error);
        }
    });
}

// Attach the saveColumnDetails function to the submit button
$('#save_columns').on('click', function(event) {
    event.preventDefault();  // Prevent default form submission (if any)
    saveColumnDetails();  // Call the function to save the column details
});











    function generateReport() {
    // Prepare the data object to hold database name, tables, columns, and selected types
    var reportData = {};

    // Get the database name (you may need to update this to get it dynamically, if necessary)
    var dbName = $('#db_select').val(); // Assuming you have a field for the database name

    // Add database name to the report data
    reportData.db_name = dbName;

    // Iterate over the table sections
    $('.table-section').each(function() {
        var tableName = $(this).find('h4').text(); // Get the table name
        var columns = {};

        // Iterate over each column in the table section
        $(this).find('.form-group').each(function() {
            var columnName = $(this).find('label').first().text().replace(':', ''); // Get column name
            var selectedTypes = [];

            // Check which checkboxes are selected for this column
            $(this).find('.form-check-input:checked').each(function() {
                var typeValue = $(this).val();
                selectedTypes.push(typeValue); // Add selected type to array
            });

            // If no checkboxes are selected, we don't need to include the column
            if (selectedTypes.length > 0) {
                // Add the column's selected types to the columns object
                columns[columnName] = selectedTypes;
            }
        });

        // If the table has any selected columns, add it to the reportData object
        if (Object.keys(columns).length > 0) {
            reportData[tableName] = columns;
        }
    });

    // Send the gathered data via an AJAX request
    $.ajax({
        url: '/generate_report/',  // Replace with your Django view URL
        type: 'POST',
        data: {
            report_data: JSON.stringify(reportData),  // Send the reportData object as a JSON string
            csrfmiddlewaretoken: $('input[name="csrfmiddlewaretoken"]').val()  // CSRF token for security
        },
        success: function(response) {
            $('#report_area').html(response.report);

            // Handle the server response here (e.g., display the report)
            console.log('Report generated successfully:', response);
        },
        error: function(xhr, status, error) {
            console.log('Error generating report:', error);
        }
    });
}

// Attach the generateReport function to the submit button
$('#submit_btn').on('click', function(event) {
    event.preventDefault();  // Prevent default form submission (if any)
    generateReport();  // Call the function to generate the report
});










    // Collect selected columns and their conditions when the submit button is clicked
    // $('#submit_btn').click(function() {
    //     var selectedColumns = [];
    //     var conditions = {};
    //     var dbName = $('#db_select').val();  // Get the selected database name
    //     var tableName = $('#table_select').val();  // Get the selected table name

    //     // Get the selected columns and their conditions
    //     $('input[name="columns"]:checked').each(function() {
    //         var column = $(this).val();  // Get selected column name
    //         selectedColumns.push(column);
            
    //     });

    //     // Send the selected columns, conditions, db_name, and table_name to the backend
    //     $.ajax({
    //         url: '/generate_report/',  // Django view URL
    //         type: 'POST',
    //         data: {
    //             'db_name': dbName,  // Send db_name
    //             'table_name': tableName,  // Send table_name
    //             'columns': selectedColumns,  // Send the selected columns
    //             'csrfmiddlewaretoken': $('input[name="csrfmiddlewaretoken"]').val(),  // CSRF token
    //         },
    //         success: function(response) {
    //             $('#report_area').html(response.report);  // Display the generated report
    //         },
    //         error: function(xhr, status, error) {
    //             console.error("Error: " + error);
    //         }
    //     });
    // });










        $('#close_connection_btn').click(function() {
        $.ajax({
            type: 'POST',
            url: '{% url "close_connection" %}',  // Django URL to close the connection
            data: { 'action': 'close' },
            success: function(response) {
                alert(response.message);  // Alert the user about the connection status
                
                // Redirect to the new URL received from the server
                window.location.href = response.redirect_url;
            },
            error: function() {
                alert('Error closing the connection.');
            }
        });
    });


    </script>

</body>
</html>
