<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Data Quality Check Report</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet" >
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://getbootstrap.com/docs/5.2/assets/css/docs.css" rel="stylesheet" />
</head>
<body>
    <div class="container mt-4">
        <h2 class="text-center my-3">Data Quality Check Report</h2>

        {% if report %}
                    
            <div class="table-responsive" id = 'report-container' data-report="{{ report|escapejs }}">
                <table class="table table-light table-bordered table-hover">
                    <thead>
                        <tr>
                            <th>Table Name</th>
                            <th>Column Name</th>
                            <th>Check Type</th>
                            <th>Result</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for table_name, checks in report.items %}
                                <tr>
                                    <td rowspan={{ checks|length }}>{{ table_name }}</td>
                            {% for check in checks %}
                                    <td>{{ check.column_name }}</td>
                                    <td>{{ check.check_name }}</td>
                                    <td>{{ check.result }}</td>
                                </tr>
                            {% endfor %}

                        {% endfor %}
                    </tbody>
                </table>
                <div class="input-group my-3">
                    <label for="report name" class="input-group-text">Enter Report Name to Save:</label>
                    <input type="text" id="report_name" class="form-control " onchange="">
                </div>
            </div>
        {% else %}
            <div class="d-flex alert alert-primary alert-dismissible align-items-center mt-4" role="alert">                <div class="d-flex">
                <svg xmlns="http://www.w3.org/2000/svg" class="bi bi-exclamation-triangle-fill flex-shrink-0 me-2 mt-1"
                    viewBox="0 0 16 16" role="img" aria-label="Warning:">
                    <path
                        d="M8.982 1.566a1.13 1.13 0 0 0-1.96 0L.165 13.233c-.457.778.091 1.767.98 1.767h13.713c.889 0 1.438-.99.98-1.767L8.982 1.566zM8 5c.535 0 .954.462.9.995l-.35 3.507a.552.552 0 0 1-1.1 0L7.1 5.995A.905.905 0 0 1 8 5zm.002 6a1 1 0 1 1 0 2 1 1 0 0 1 0-2z">
                    </path>
                </svg>
                <div class="d-flex">
                    No data quality checks available. Select the Database and Tables
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            </div>
    </div>
        {% endif %}
        <div class="gap-3 d-flex justify-content-between">
            <div>
                <a href="{% url 'db_info' %}" class="btn btn-primary mb-1">Go Back</a>
                <button class="btn btn-primary mb-1 " id="closeModalBtn" onclick="document.getElementById('report_area').close(); document.getElementById('report_area').style.display = 'none';">Add More</button>    
            </div>
        {% if report %}
            <div>                
                <button class="btn btn-primary mb-1 " id="save_report_btn" onclick="saveReport()" >Save Report</button>    
                <button class="btn btn-primary mb-1" id="download_report_btn" onclick="">Download</button>    
            </div>
        {% endif %}
        </div>

        {% if report %}

        {% else %}
        <div class="text-center">
            <img src="/static/src/report.png" class="mx-auto" style="height: 50vh; width: auto; " alt=" ">
        </div>
        {% endif %}

    <!-- Bootstrap JS (optional for certain components) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js" ></script>
    <script>
        const myInput = document.getElementById('report_name');
        const myButton = document.getElementById('save_report_btn');

        // Function to enable or disable the button based on input text
        function toggleButtonState() {
            if (myInput.value.trim() !== "") {
            myButton.disabled = false;  // Enable button if input has text
            } else {
            myButton.disabled = true;   // Disable button if input is empty
            }
        }

        // Add event listener to input field to trigger the toggle function
        myInput.addEventListener('input', toggleButtonState);

        // Initial check in case the input field has pre-filled text (e.g., in form submission)
        toggleButtonState();

        function saveReport() {
            var reportData = document.getElementById('report-container').getAttribute('data-report');


            // Now you can use the reportData variable in your JavaScript
            console.log(reportData);            // Capture the values from the input fields
            const reportName = document.getElementById('report_name').value;

            // Generate timestamp (current time in ISO format)
            const timestamp = (new Date().toLocaleString('en-IN', { timeZone: 'Asia/Kolkata' }));

            // Construct the data to be sent in the POST request
            const reportPayload = {
                name: reportName,
                report: reportData,
                timestamp: timestamp
            };

            // Send the POST request using Fetch API
            fetch('/save_quality_check_report/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(reportPayload)  // Convert the payload to JSON
            })
            .then(response => response.json())
            .then(data => {
                // Handle the response from the backend
                if (data.message) {
                    alert(data.message);  // Show success or error message
                }
            })
            .catch(error => {
                // Handle any errors
                console.error('Error saving the report:', error);
                alert('An error occurred while saving the report');
            });
        }

</script>

</body>

</html>
